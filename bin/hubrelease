#!/usr/bin/env ruby
STDOUT.sync = true

$:.unshift File.join(File.dirname(__FILE__), "..", "lib")

require "optparse"
require "hubrelease"

options = {}
opts = OptionParser.new do |o|
  o.banner = "Usage: hubrelease [options]"

  o.on "--repo USER/REPO", "Repository (user/repo)" do |repo|
    options[:repo] = repo
  end

  o.on "--prev PREVIOUS", "Previous release tag name" do |p|
    options[:prev] = p
  end

  o.on "--new NEW", "Next release tag name" do |n|
    options[:new] = n
  end

  o.on "--token TOKEN", "GitHub API token" do |token|
    options[:token] = token
  end

  o.on_tail "-h", "--help", "Show this message" do
    puts o
    exit
  end
end

begin
  opts.parse!
  mandatory = [:repo, :prev, :new, :token]
  missing = mandatory.select{ |param| options[param].nil? }

  unless missing.empty?
    puts "Missing options: #{missing.join(', ')}"
    puts opts
    exit
  end
rescue OptionParser::InvalidOption, OptionParser::MissingArgument
  puts $!.to_s
  puts opts
  exit
end

HubRelease::Generator.new(options).generate
